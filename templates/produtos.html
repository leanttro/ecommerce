<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ p.nome }} | {{ loja.nome }}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family={{ loja.font_titulo }}:wght@400;700&family={{ loja.font_corpo }}:wght@300;400;600&display=swap');
        
        :root { 
            --primary: {{ loja.cor_primaria }}; 
            --color-bg: {{ loja.cor_fundo or '#ffffff' }};
            --color-title: {{ loja.cor_titulo or '#111827' }};
            --color-text: {{ loja.cor_texto or '#374151' }};
            
            --font-head: '{{ loja.font_titulo }}', sans-serif;
            --font-body: '{{ loja.font_corpo }}', sans-serif;
            --font-size-base: {{ loja.font_tamanho_base or 16 }}px;
        }
        
        body { 
            font-family: var(--font-body); 
            font-size: var(--font-size-base);
            color: var(--color-text);
        }
        
        h1, h2, h3, h4, .font-display { 
            font-family: var(--font-head); 
            color: var(--color-title);
        }
        
        .text-theme { color: var(--primary); }
        .bg-theme { background-color: var(--primary); }
        .border-theme { border-color: var(--primary); }
        .hover\:bg-theme:hover { background-color: var(--primary); }
        
        /* Aplica cor de fundo personalizada */
        .custom-bg { background-color: var(--color-bg); }
        .custom-title-color { color: var(--color-title); }
        
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        
        /* Ticker CSS */
        .ticker-wrap {
            overflow: hidden;
            white-space: nowrap;
            background: var(--primary);
            color: var(--color-bg); /* Letras com a cor do fundo (Body) */
            height: 30px;
            display: flex;
            align-items: center;
        }
        .ticker {
            display: inline-block;
            animation: ticker 30s linear infinite;
            padding-left: 100%;
        }
        .ticker span {
            display: inline-block;
            padding: 0 40px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* Ajustes para o conte√∫do da descri√ß√£o */
        .prose { 
            line-height: 1.8; 
            white-space: pre-line; 
        }
        .prose strong, .prose b { color: var(--color-title); font-weight: 700; }
        .prose a { color: var(--primary); text-decoration: underline; }
    </style>
</head>
<body class="custom-bg flex flex-col min-h-screen">

    {% if loja.frase1 or loja.frase2 or loja.frase3 %}
    <div class="ticker-wrap">
        <div class="ticker">
            {% if loja.frase1 %}<span>{{ loja.frase1 }}</span>{% endif %}
            {% if loja.frase2 %}<span>{{ loja.frase2 }}</span>{% endif %}
            {% if loja.frase3 %}<span>{{ loja.frase3 }}</span>{% endif %}
            {% if loja.frase1 %}<span>{{ loja.frase1 }}</span>{% endif %}
            {% if loja.frase2 %}<span>{{ loja.frase2 }}</span>{% endif %}
            {% if loja.frase3 %}<span>{{ loja.frase3 }}</span>{% endif %}
        </div>
    </div>
    {% endif %}

    <nav class="sticky top-0 z-40 shadow-sm border-b border-gray-100 transition-colors custom-bg py-4 md:py-0">
        <div class="container mx-auto px-4 min-h-[80px] flex flex-col md:flex-row items-center justify-between">
            
            <a href="/{{ loja.slug_url }}/" class="flex items-center gap-2 mb-2 md:mb-0">
                {% if loja.logo %}
                    <img src="{{ loja.logo }}" alt="{{ loja.nome }}" class="h-16 md:h-20 w-auto object-contain">
                {% else %}
                    <span class="text-2xl font-bold tracking-tight custom-title-color">{{ loja.nome }}</span>
                {% endif %}
            </a>

            <div class="flex items-center gap-4">
                 <a href="/{{ loja.slug_url }}/" class="md:hidden p-2 custom-title-color">
                    <i data-lucide="home" class="w-6 h-6"></i>
                </a>
                
                <button onclick="toggleCart()" class="relative p-2 hover:opacity-70 transition custom-title-color">
                    <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                    <span id="cart-count-badge" class="absolute top-0 right-0 bg-theme text-white text-[10px] w-4 h-4 flex items-center justify-center rounded-full font-bold hidden">0</span>
                </button>
            </div>
        </div>
        
        <div class="hidden md:flex justify-center border-t border-gray-50 py-3 custom-bg">
            <ul class="flex gap-8 text-sm font-bold uppercase tracking-widest custom-title-color opacity-80">
                <li><a href="/{{ loja.slug_url }}/" class="hover:text-theme transition">In√≠cio</a></li>
                <li><a href="/{{ loja.slug_url }}/#produtos" class="hover:text-theme transition">Produtos</a></li>
                <li><a href="#footer" class="hover:text-theme transition">Contato</a></li>
            </ul>
        </div>
    </nav>

    <div class="border-b border-gray-100 py-3 opacity-70">
        <div class="container mx-auto px-4 text-xs uppercase tracking-widest flex items-center gap-2">
            <a href="/{{ loja.slug_url }}/" class="hover:text-theme">In√≠cio</a> 
            <i data-lucide="chevron-right" class="w-3 h-3"></i>
            <span class="font-bold">{{ p.nome }}</span>
        </div>
    </div>

    <section class="py-12 container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            
            <div class="space-y-4">
                <div class="aspect-square bg-white rounded-xl overflow-hidden border border-gray-100 relative group shadow-sm">
                    <img id="main-image" src="{{ p.galeria[0] }}" class="w-full h-full object-cover transition-opacity duration-300">
                </div>
                
                {% if p.galeria|length > 1 %}
                <div class="flex gap-4 overflow-x-auto pb-2 justify-center md:justify-start">
                    {% for img in p.galeria %}
                    <button onclick="changeImage('{{ img }}')" class="w-20 h-20 rounded-lg border-2 border-transparent hover:border-theme overflow-hidden flex-shrink-0 transition-all cursor-pointer">
                        <img src="{{ img }}" class="w-full h-full object-cover hover:opacity-80 transition-opacity">
                    </button>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="text-center md:text-left">
                <h1 class="text-3xl md:text-4xl font-bold mb-2 leading-tight custom-title-color">{{ p.nome }}</h1>
                <div class="text-xs text-gray-400 mb-6 uppercase tracking-widest">Ref: {{ p.id[:8] }}</div>

                <div class="mb-6">
                    {% if p.consulte %}
                        <span class="text-3xl font-bold text-blue-600">Consulte-nos</span>
                        <span class="text-sm opacity-70 font-bold block mt-1">Entre em contato para or√ßamento</span>
                    {% elif p.estoque == 0 %}
                        <span class="text-3xl font-bold text-gray-400 line-through">R$ {{ "%.2f"|format(p.preco)|replace('.', ',') }}</span>
                        <span class="text-sm text-red-500 font-bold block mt-1 uppercase">Produto Indispon√≠vel</span>
                    {% elif p.preco %}
                        <span class="text-4xl font-bold text-theme">R$ {{ "%.2f"|format(p.preco)|replace('.', ',') }}</span>
                        <span class="text-sm opacity-70 font-bold block mt-1">√† vista</span>
                    {% else %}
                        <span class="text-2xl font-bold opacity-50 uppercase">Pre√ßo sob consulta</span>
                    {% endif %}
                </div>

                {% if p.variantes and p.variantes|length > 0 %}
                <div class="mb-8">
                    <label class="text-sm font-bold uppercase tracking-wide block mb-3 custom-title-color">
                        Op√ß√µes: <span id="color-label" class="text-theme font-normal"></span>
                    </label>
                    <div class="flex flex-wrap gap-3 justify-center md:justify-start">
                        {% for v in p.variantes %}
                        <button onclick="selectVariant('{{ v.nome }}', '{{ v.foto }}')" 
                                class="w-10 h-10 rounded-full border-2 border-gray-200 hover:border-theme focus:ring-2 ring-theme ring-offset-2 bg-cover bg-center transition-all"
                                style="background-image: url('{{ v.foto }}');"
                                title="{{ v.nome }}">
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="flex flex-col md:flex-row gap-4 mb-8">
                    
                    {% if p.estoque == 0 %}
                        <button disabled class="flex-1 bg-gray-300 text-gray-500 font-bold py-4 rounded-xl text-sm uppercase tracking-widest cursor-not-allowed flex items-center justify-center gap-2">
                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                            <span>Produto Indispon√≠vel (Sem Estoque)</span>
                        </button>
                    {% else %}
                        <button onclick='addToCartPage({{ p | tojson }})' class="flex-1 bg-theme text-white font-bold py-4 rounded-xl text-sm uppercase tracking-widest transition-opacity hover:opacity-90 shadow-lg flex items-center justify-center gap-2 active:scale-95">
                            <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                            <span id="btn-add-text">Adicionar √† Sacola</span>
                        </button>
                    {% endif %}

                    <a href="https://wa.me/55{{ loja.whatsapp_comercial }}?text=Tenho%20d√∫vida%20sobre:%20{{ p.nome }}" target="_blank" class="px-6 py-4 border border-gray-300 rounded-xl hover:bg-gray-50 opacity-70 hover:opacity-100 transition-all flex items-center justify-center">
                        <i data-lucide="message-circle" class="w-6 h-6"></i> <span class="md:hidden ml-2 font-bold">D√∫vidas?</span>
                    </a>
                </div>

                <div class="bg-white/50 rounded-xl p-6 border border-gray-100 mb-8 text-left backdrop-blur-sm">
                    <h3 class="font-bold text-lg mb-4 custom-title-color border-b border-gray-100 pb-2">Detalhes do Produto</h3>
                    <div class="prose text-sm opacity-80 leading-relaxed">
                        {{ p.descricao | safe }}
                    </div>
                </div>

            </div>
        </div>
    </section>

    <footer class="bg-theme text-white py-12 mt-auto" style="background-color: var(--primary);" id="footer">
        <div class="container mx-auto px-4 text-center">
            <h4 class="font-bold text-lg mb-4">{{ loja.nome }}</h4>
            <p class="text-sm mb-6 opacity-80">Todos os direitos reservados.</p>
            
            <div class="flex justify-center gap-4 text-sm">
                <a href="#" class="hover:underline">Pol√≠tica de Privacidade</a>
                <a href="#" class="hover:underline">Termos de Uso</a>
            </div>

            <div class="mt-8 pt-8 border-t border-white/20">
                <a href="/{{ loja.slug_url }}/admin" class="text-xs font-bold uppercase tracking-widest hover:text-white flex items-center justify-center gap-2">
                    <i data-lucide="lock" class="w-3 h-3"></i> √Årea do Lojista
                </a>
            </div>
        </div>
    </footer>

    <a href="https://wa.me/55{{ loja.whatsapp_comercial }}" target="_blank" 
       class="fixed bottom-4 right-4 z-50 bg-green-500 hover:bg-green-600 text-white p-3 md:p-4 rounded-full shadow-2xl transition-all hover:scale-110 flex items-center justify-center animate-bounce">
        <i data-lucide="message-circle" class="w-6 h-6 md:w-8 md:h-8"></i>
    </a>

    <div id="cart-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 modal-overlay transition-opacity duration-300" onclick="toggleCart()"></div>
        <div class="absolute right-0 top-0 h-full w-full md:w-[450px] bg-white shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-full" id="cart-panel">
            
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h2 class="font-bold text-lg flex items-center gap-2 text-gray-800"><i data-lucide="shopping-cart" class="w-5 h-5 text-theme"></i> Sua Sacola</h2>
                <button onclick="toggleCart()" class="text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6" id="cart-items"></div>

            <div class="p-6 border-t bg-gray-50 space-y-4 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                
                <div class="flex justify-between items-center text-xl font-bold pt-2 border-t border-gray-200">
                    <span class="text-gray-600">Total:</span><span id="cart-total" class="text-theme">R$ 0,00</span>
                </div>
                
                <button onclick="finalizarNoZap()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-green-200 hover:shadow-green-300 transition-all active:scale-95">
                    <i data-lucide="message-circle" class="w-5 h-5"></i> FECHAR PEDIDO NO WHATSAPP
                </button>
                <p class="text-[10px] text-center text-gray-400">Pagamento e frete combinados diretamente no WhatsApp.</p>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        let selectedColor = null;
        let selectedPhoto = "{{ p.galeria[0] }}";
        const lojaPhone = "55{{ loja.whatsapp_comercial }}";

        // --- FUN√á√ïES VISUAIS ---
        function changeImage(src) {
            document.getElementById('main-image').src = src;
        }

        function selectVariant(name, photo) {
            selectedColor = name;
            selectedPhoto = photo;
            document.getElementById('color-label').innerText = name;
            changeImage(photo);
        }

        // --- L√ìGICA DO CARRINHO (MESMA DA INDEX) ---
        let cart = []; 
        try { cart = JSON.parse(localStorage.getItem('cart_v2') || '[]'); } catch(e) { cart = []; }

        function saveCart() { localStorage.setItem('cart_v2', JSON.stringify(cart)); updateCartUI(); }

        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            const panel = document.getElementById('cart-panel');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => panel.classList.remove('translate-x-full'), 10);
            } else {
                panel.classList.add('translate-x-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function changeQty(idx, delta) {
            if (cart[idx]) {
                cart[idx].qtd += delta;
                if (cart[idx].qtd <= 0) cart.splice(idx, 1);
                saveCart();
            }
        }

        function removeFromCart(idx) { cart.splice(idx, 1); saveCart(); }

        function addToCartPage(product) {
            let final = { ...product };
            if (selectedColor) {
                final.nome_exibicao = `${product.nome} (${selectedColor})`;
                final.imagem = selectedPhoto;
                final.cart_id = `${product.id}-${selectedColor}`;
            } else {
                final.nome_exibicao = product.nome;
                final.imagem = product.galeria[0];
                final.cart_id = `${product.id}-padrao`;
            }

            const idx = cart.findIndex(i => i.cart_id === final.cart_id);
            if (idx > -1) cart[idx].qtd++; else { final.qtd = 1; cart.push(final); }
            
            saveCart();
            toggleCart();
            
            const btn = document.getElementById('btn-add-text');
            if(btn) {
                const old = btn.innerText;
                btn.innerText = "Adicionado!";
                setTimeout(() => btn.innerText = old, 2000);
            }
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            const totalEl = document.getElementById('cart-total');
            const countBadge = document.getElementById('cart-count-badge');

            const totalQtd = cart.reduce((acc, i) => acc + i.qtd, 0);
            if(countBadge) {
                countBadge.innerText = totalQtd;
                countBadge.classList.toggle('hidden', totalQtd === 0);
            }

            if(container) {
                container.innerHTML = '';
                let total = 0;
                
                if (cart.length === 0) {
                    container.innerHTML = `<div class="text-center py-10 opacity-50"><i data-lucide="shopping-bag" class="w-12 h-12 mx-auto mb-2"></i><p class="text-sm">Sua sacola est√° vazia.</p></div>`;
                }

                cart.forEach((item, i) => {
                    // Se item tem pre√ßo, soma. Se n√£o (consulte), pre√ßo √© 0
                    let itemPrice = item.consulte ? 0 : (item.preco || 0);
                    total += itemPrice * item.qtd;
                    
                    let priceDisplay = item.consulte ? "Sob Consulta" : `R$ ${(itemPrice * item.qtd).toFixed(2).replace('.',',')}`;

                    container.innerHTML += `
                        <div class="flex gap-4 border-b border-gray-100 pb-4 last:border-0">
                            <img src="${item.imagem}" class="w-16 h-16 object-cover rounded-md bg-gray-100 border border-gray-200">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-xs text-gray-800 line-clamp-2 leading-snug mb-1">${item.nome_exibicao}</h4>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-theme font-bold text-sm">${priceDisplay}</span>
                                    <div class="flex items-center gap-2 bg-gray-100 rounded-lg px-2 py-1 border border-gray-200">
                                        <button onclick="changeQty(${i}, -1)" class="w-5 h-5 flex items-center justify-center text-gray-500 font-bold">-</button>
                                        <span class="text-xs font-bold text-gray-800 w-4 text-center">${item.qtd}</span>
                                        <button onclick="changeQty(${i}, 1)" class="w-5 h-5 flex items-center justify-center text-gray-500 font-bold">+</button>
                                        <div class="w-px h-3 bg-gray-300 mx-1"></div>
                                        <button onclick="removeFromCart(${i})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });
                if(totalEl) totalEl.innerText = "R$ " + total.toFixed(2).replace('.', ',');
                lucide.createIcons();
            }
        }

        function finalizingNoZap() {
            // Alias para manter compatibilidade caso use o nome antigo
            finalizarNoZap();
        }

        function finalizarNoZap() {
            if (cart.length === 0) return alert("Adicione produtos primeiro!");
            
            let msg = `üëã Ol√°! Vim do site e quero fechar meu pedido:\n\n`;
            let total = 0;
            
            cart.forEach(i => {
                msg += `‚Äî ${i.qtd}x ${i.nome_exibicao}\n`;
                if(i.consulte) {
                     msg += `   (Pre√ßo sob Consulta)\n`;
                } else if(i.preco) {
                    msg += `   R$ ${(i.preco * i.qtd).toFixed(2)}\n`;
                    total += i.preco * i.qtd;
                } else {
                    msg += `   (Sob Consulta)\n`;
                }
            });
            
            msg += `--------------------------------\n`;
            msg += `*üí∞ Total:* R$ ${total.toFixed(2).replace('.', ',')}\n`;
            msg += `\nAguardo as instru√ß√µes de pagamento!`;

            const url = `https://wa.me/${lojaPhone}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        // Inicializa
        updateCartUI();
    </script>
</body>
</html>